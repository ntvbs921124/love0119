<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Xmas Magic - Final Edition</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; touch-action: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; transition: 0.8s; }
        
        /* ä¸‰æ˜Ÿæ‰‹æ©Ÿå„ªåŒ–æ„Ÿæ‡‰çª— - åœ“å‹é›·é”ï¼Œé¿é–‹åº•éƒ¨å·¥å…·åˆ— */
        #gesture-canvas { 
            position: absolute; bottom: 90px; right: 15px; width: 110px; height: 110px; 
            border: 2px solid #ffd700; border-radius: 50%; 
            z-index: 100; transform: scaleX(-1); background: rgba(0,0,0,0.5);
            object-fit: cover; box-shadow: 0 0 15px rgba(255,215,0,0.4);
        }
        
        #gallery-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.96); z-index: 20; opacity: 0; pointer-events: none; transition: 0.5s; }
        #gallery-photo { max-width: 90%; max-height: 65%; border-radius: 12px; box-shadow: 0 0 40px rgba(255,255,255,0.15); object-fit: contain; }
        
        #lib-toggle { position: absolute; top: 15px; left: 15px; z-index: 150; background: rgba(255,255,255,0.1); border: 1px solid #ffd700; color: #fff; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; backdrop-filter: blur(5px); }
        #library { position: absolute; top: 0; left: -100%; width: 85%; max-width: 320px; height: 100%; background: #0f0f0f; z-index: 200; transition: 0.4s; padding: 25px; color: #ccc; overflow-y: auto; box-shadow: 5px 0 20px rgba(0,0,0,0.5); }
        #library.open { left: 0; }
        .slot { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        
        .ui-overlay { position: absolute; top: 12%; width: 100%; pointer-events: none; z-index: 10; text-align: center; color: white; }
        .main-title { font-size: 1.6rem; letter-spacing: 6px; color: #ffd700; margin-bottom: 8px; font-weight: 300; text-shadow: 0 0 10px rgba(255,215,0,0.5); }
        #status-box { background: rgba(0,0,0,0.7); padding: 12px 20px; border-radius: 25px; display: inline-block; border: 1px solid rgba(255,215,0,0.3); backdrop-filter: blur(5px); }
        
        #video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        
        body.gallery-active #canvas-container { filter: blur(30px) brightness(0.3); }
        body.gallery-active #gallery-container { opacity: 1; pointer-events: auto; }
        .flash { animation: flash-info 0.6s ease; }
        @keyframes flash-info { 0% { background: #ffd700; color: #000; } 100% { background: rgba(0,0,0,0.7); color: #fff; } }
    </style>
</head>
<body>
    <button id="lib-toggle">âš™ï¸</button>
    <div id="library">
        <h3 style="color:#fff; margin-top:0;">ğŸ“¸ å€‹äººç…§ç‰‡åº«</h3>
        <p style="font-size:12px; color:#888;">ä¸Šå‚³å¾Œï¼Œå¼µé–‹æ‰‹æŒå³å¯åœ¨æ˜Ÿç©ºä¸­å±•ç¤º</p>
        <div id="file-inputs"></div>
        <button style="width:100%; padding:15px; background:#ffd700; color:#000; border:none; border-radius:10px; font-weight:bold; margin-top:10px; cursor:pointer;" onclick="saveLocalPhotos()">å„²å­˜è¨­å®šä¸¦é‡å•Ÿ</button>
    </div>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="gesture-canvas"></canvas>
    <div id="canvas-container"></div>
    <div id="gallery-container"><img id="gallery-photo" src=""></div>

    <div class="ui-overlay">
        <div class="main-title">REAL MAGIC XMAS</div>
        <div id="status-box"><div id="hint-text">è«‹æˆæ¬Šç›¸æ©Ÿæ¬Šé™...</div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>

    <script type="module">
        import * as THREE from 'three';

        // --- 1. ç…§ç‰‡ç³»çµ± ---
        let photos = JSON.parse(localStorage.getItem('local_xmas_gallery')) || [];
        const inputContainer = document.getElementById('file-inputs');
        for(let i=0; i<8; i++) {
            const div = document.createElement('div');
            div.className = 'slot';
            div.innerHTML = `
                <label style="font-size:12px; display:block; margin-bottom:5px;">ä½ç½® ${i+1}</label>
                <input type="file" id="f-${i}" accept="image/*" onchange="previewFile(${i})">
                <img id="prev-${i}" style="width:40px;height:40px;display:${photos[i]?'inline-block':'none'};margin-top:8px;border-radius:4px;border:1px solid #444;" src="${photos[i]||''}">
            `;
            inputContainer.appendChild(div);
        }
        window.previewFile = (i) => {
            const r = new FileReader(); r.onloadend = () => { 
                const img = document.getElementById(`prev-${i}`); 
                img.src = r.result; 
                img.style.display = 'inline-block'; 
            };
            if (document.getElementById(`f-${i}`).files[0]) r.readAsDataURL(document.getElementById(`f-${i}`).files[0]);
        };
        window.saveLocalPhotos = () => {
            const np = []; for(let i=0; i<8; i++){ 
                const s = document.getElementById(`prev-${i}`).src; 
                if(s.startsWith('data:')) np.push(s); 
            }
            try {
                localStorage.setItem('local_xmas_gallery', JSON.stringify(np));
                location.reload();
            } catch(e) { alert("ç…§ç‰‡å¤ªå¤šæˆ–å¤ªå¤§äº†ï¼Œè«‹æ¸›å°‘å¹¾å¼µç…§ç‰‡ï¼"); }
        };
        document.getElementById('lib-toggle').onclick = () => document.getElementById('library').classList.toggle('open');

        // --- 2. Three.js è±ªè¯å¯¦é«”è–èª•æ¨¹ ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 65);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const treeGroup = new THREE.Group();
        // å¯¦é«”æ¨¹èº«
        for(let i=0; i<3; i++) {
            const geo = new THREE.ConeGeometry(18 - i*4, 15, 32);
            const mat = new THREE.MeshStandardMaterial({ color: 0x0a3d0a, roughness: 0.8 });
            const p = new THREE.Mesh(geo, mat); p.position.y = i*8 - 12;
            treeGroup.add(p);
        }
        // èºæ—‹ç‡ˆä¸²ç²’å­
        const lightGeo = new THREE.BufferGeometry();
        const lightPos = [];
        for(let i=0; i<500; i++) {
            const t = i / 500; const a = t * Math.PI * 20; const r = (1 - t) * 16;
            lightPos.push(Math.cos(a)*r, t*38 - 15, Math.sin(a)*r);
        }
        lightGeo.setAttribute('position', new THREE.Float32BufferAttribute(lightPos, 3));
        const lights = new THREE.Points(lightGeo, new THREE.PointsMaterial({ color: 0xffd700, size: 0.4, blending: THREE.AdditiveBlending }));
        treeGroup.add(lights);

        // è£é£¾çƒ
        const ballColors = [0xff0000, 0xffd700, 0xffffff, 0x00ccff];
        for(let i=0; i<30; i++) {
            const t = Math.random(); const r = (1-t) * 16; const a = Math.random() * Math.PI * 2;
            const bGeo = new THREE.SphereGeometry(0.7, 8, 8);
            const bMat = new THREE.MeshStandardMaterial({ color: ballColors[i%4], emissive: ballColors[i%4], emissiveIntensity: 0.5 });
            const b = new THREE.Mesh(bGeo, bMat);
            b.position.set(Math.cos(a)*r, t*35 - 15, Math.sin(a)*r);
            treeGroup.add(b);
        }

        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        scene.add(treeGroup);

        // --- 3. AI æ‰‹å‹¢èˆ‡ç›¸æ©Ÿæ ¸å¿ƒ (ä¸‰æ˜Ÿå„ªåŒ–ç‰ˆ) ---
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('gesture-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        let currentMode = 'tree', photoIdx = 0, rotVel = 0.005, gestureCooldown = false;
        const mainImg = document.getElementById('gallery-photo');
        if(photos.length > 0) mainImg.src = photos[0];

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

        hands.onResults((res) => {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, 110, 110);
            if (res.image) {
                canvasCtx.drawImage(res.image, 0, 0, 110, 110);
                if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                    const m = res.multiHandLandmarks[0];
                    drawConnectors(canvasCtx, m, HAND_CONNECTIONS, {color: '#ffd700', lineWidth: 2});
                    const d = Math.sqrt(Math.pow(m[4].x - m[8].x, 2) + Math.pow(m[4].y - m[8].y, 2));
                    
                    if (!gestureCooldown) {
                        if (currentMode === 'tree') {
                            rotVel = (m[8].x - 0.5) * 0.15;
                            if (d > 0.42) { currentMode='gallery'; document.body.className='gallery-active'; triggerFeedback("ç›¸ç°¿æ¨¡å¼"); }
                        } else {
                            if (d < 0.12) { currentMode='tree'; document.body.className=''; triggerFeedback("è–èª•æ¨¹æ¨¡å¼"); }
                            if (m[8].x < 0.25) changePhoto(1); else if (m[8].x > 0.75) changePhoto(-1);
                        }
                    }
                }
            }
            canvasCtx.restore();
        });

        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user", width: 640, height: 480 } 
                });
                videoElement.srcObject = stream;
                videoElement.onloadedmetadata = () => {
                    videoElement.play();
                    const cam = new Camera(videoElement, {
                        onFrame: async () => { await hands.send({image: videoElement}); },
                        width: 640, height: 480
                    });
                    cam.start();
                    document.getElementById('hint-text').innerText = "ğŸ‘ å¼µé–‹æ‰‹é€²å…¥ç›¸ç°¿";
                };
            } catch (err) {
                document.getElementById('hint-text').innerText = "âš ï¸ è«‹é»æ“Šç¶²å€åˆ—å·¦å´å…è¨±ç›¸æ©Ÿ";
            }
        }

        initCamera();

        function triggerFeedback(txt) {
            gestureCooldown = true; 
            if(txt) document.getElementById('hint-text').innerText = txt;
            document.getElementById('status-box').classList.add('flash');
            setTimeout(() => { document.getElementById('status-box').classList.remove('flash'); gestureCooldown = false; }, 1200);
        }

        function changePhoto(s) {
            if(photos.length === 0) return;
            photoIdx = (photoIdx + s + photos.length) % photos.length;
            mainImg.style.opacity = 0;
            setTimeout(() => { mainImg.src = photos[photoIdx]; mainImg.style.opacity = 1; }, 200);
            triggerFeedback();
        }

        function render() {
            requestAnimationFrame(render);
            treeGroup.rotation.y += rotVel;
            lights.material.size = 0.4 + Math.sin(Date.now()*0.003)*0.1;
            renderer.render(scene, camera);
        }
        render();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
