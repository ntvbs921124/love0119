<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Xmas - Gesture Fixed</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* AI åµæ¸¬ç•«å¸ƒ (æ”¾åœ¨å·¦ä¸‹è§’ï¼Œå¹«åŠ©ç¢ºèª AI æ˜¯å¦æœ‰æŠ“åˆ°ä½ çš„æ‰‹) */
        #gesture-canvas { 
            position: absolute; bottom: 10px; right: 10px; width: 180px; height: 135px; 
            border: 2px solid #ffd700; border-radius: 8px; z-index: 50; transform: scaleX(-1);
            background: rgba(0,0,0,0.5);
        }
        
        #gallery-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.9); z-index: 20;
            opacity: 0; pointer-events: none; transition: 0.6s;
        }
        #gallery-photo { max-width: 85%; max-height: 80%; border-radius: 15px; box-shadow: 0 0 50px #fff3; object-fit: contain; }

        #lib-toggle { position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(255,255,255,0.1); border: 1px solid #444; color: #fff; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; }
        #library { position: absolute; top: 0; left: -320px; width: 300px; height: 100%; background: rgba(15,15,15,0.98); z-index: 99; transition: 0.4s; padding: 20px; color: #ccc; overflow-y: auto; }
        #library.open { left: 0; }
        .slot { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        #video { display: none; } /* éš±è—åŸå§‹è¦–è¨Šï¼Œæ”¹ç”¨ç•«å¸ƒç¹ªè£½ */
        
        .ui-overlay {
            position: absolute; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between; padding: 50px 0;
            text-align: center; color: white;
        }
        .main-title { font-size: 2rem; letter-spacing: 10px; font-weight: 100; color: #ffd700; }
        #status-box { background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 30px; align-self: center; border: 1px solid #ffd700; }
        
        body.gallery-active #canvas-container { filter: blur(20px) brightness(0.4); }
        body.gallery-active #gallery-container { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>
    <button id="lib-toggle">âš™ï¸</button>
    <div id="library">
        <h3>ğŸ“¸ æœ¬åœ°ç›¸ç°¿</h3>
        <div id="file-inputs"></div>
        <button style="width:100%; padding:12px; background:#ffd700; border:none; border-radius:25px; font-weight:bold; cursor:pointer;" onclick="saveLocalPhotos()">å„²å­˜ä¸¦é‡å•Ÿ</button>
    </div>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="gesture-canvas"></canvas> <div id="canvas-container"></div>
    <div id="gallery-container"><img id="gallery-photo" src=""></div>

    <div class="ui-overlay">
        <div class="main-title">STARRY XMAS</div>
        <div id="status-box">
            <div id="hint-text" style="color:#ffd700; font-size:16px;">AI è¦–è¦ºå•Ÿå‹•ä¸­...</div>
            <div id="debug-info" style="font-size:10px; opacity:0.6; margin-top:5px;">ç­‰å¾…æ‰‹éƒ¨é€²å…¥ç•«é¢</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script> <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>

    <script type="module">
        import * as THREE from 'three';

        // 1. ç…§ç‰‡è®€å–
        let photos = JSON.parse(localStorage.getItem('local_xmas_gallery')) || [];
        const inputContainer = document.getElementById('file-inputs');
        for(let i=0; i<10; i++) {
            inputContainer.innerHTML += `<div class="slot"><label>ç›¸ç‰‡ ${i+1}</label><input type="file" id="f-${i}" accept="image/*" onchange="previewFile(${i})"><img id="prev-${i}" style="width:40px;height:40px;display:none;margin-top:5px;" src="${photos[i]||''}"></div>`;
            if(photos[i]) document.getElementById(`prev-${i}`).style.display = 'block';
        }
        window.previewFile = (i) => {
            const f = document.getElementById(`f-${i}`).files[0];
            const r = new FileReader();
            r.onloadend = () => { const img = document.getElementById(`prev-${i}`); img.src = r.result; img.style.display = 'block'; };
            if (f) r.readAsDataURL(f);
        };
        window.saveLocalPhotos = () => {
            const np = []; for(let i=0; i<10; i++){ const s = document.getElementById(`prev-${i}`).src; if(s.startsWith('data:')) np.push(s); }
            localStorage.setItem('local_xmas_gallery', JSON.stringify(np)); location.reload();
        };
        document.getElementById('lib-toggle').onclick = () => document.getElementById('library').classList.toggle('open');

        // 2. Three.js èƒŒæ™¯
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 50;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        
        const treeGroup = new THREE.Group();
        const addP = (n, s, c, r, h) => {
            const g = new THREE.BufferGeometry(); const p = [];
            for(let i=0; i<n; i++){ const t=i/n, a=t*Math.PI*40, cr=(1-t)*r; p.push(Math.cos(a)*cr, t*h-20, Math.sin(a)*cr); }
            g.setAttribute('position', new THREE.Float32BufferAttribute(p, 3));
            return new THREE.Points(g, new THREE.PointsMaterial({ size:s, color:c, blending: THREE.AdditiveBlending, transparent:true, opacity:0.6 }));
        };
        treeGroup.add(addP(10000, 0.15, 0x1a4d1a, 18, 45));
        treeGroup.add(addP(1000, 0.3, 0xffd700, 18.5, 45));
        scene.add(treeGroup);

        // 3. AI æ‰‹å‹¢è¾¨è­˜ä¿®å¾©ç‰ˆ
        const videoElement = document.getElementById('video');
        const canvasElement = document.getElementById('gesture-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const debugInfo = document.getElementById('debug-info');
        const hintText = document.getElementById('hint-text');
        
        let mode = 'tree', idx = 0, rotVel = 0.005, cooldown = false;
        const mainImg = document.getElementById('gallery-photo');
        if(photos.length > 0) mainImg.src = photos[0];

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

        hands.onResults((res) => {
            // ç¹ªè£½ AI é è¦½çª—ï¼ˆé™¤éŒ¯ç”¨ï¼‰
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(res.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                const landmarks = res.multiHandLandmarks[0];
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#ffd700', lineWidth: 2});
                drawLandmarks(canvasCtx, landmarks, {color: '#ffffff', lineWidth: 1});

                // è¨ˆç®—é£ŸæŒ‡èˆ‡æ‹‡æŒ‡è·é›¢ (Pinch Distance)
                const dist = Math.sqrt(Math.pow(landmarks[4].x - landmarks[8].x, 2) + Math.pow(landmarks[4].y - landmarks[8].y, 2));
                debugInfo.innerText = `è·é›¢: ${dist.toFixed(2)} | Xåº§æ¨™: ${landmarks[8].x.toFixed(2)}`;

                if(mode === 'tree') {
                    rotVel = (landmarks[8].x - 0.5) * 0.12;
                    hintText.innerText = "ğŸ‘ å¼µé–‹æ‰‹æŒé€²å…¥ç›¸ç°¿";
                    if(dist > 0.4) { mode='gallery'; document.body.className='gallery-active'; }
                } else {
                    hintText.innerText = "ğŸ‘Œ æåˆæ‰‹æŒ‡è¿”å›è–èª•æ¨¹";
                    if(dist < 0.12) { mode='tree'; document.body.className=''; }
                    // æ®å‹•åˆ‡æ›
                    if(!cooldown && photos.length > 0) {
                        if(landmarks[8].x < 0.2) { 
                            idx=(idx+1)%photos.length; mainImg.src=photos[idx]; 
                            cooldown=true; setTimeout(()=>cooldown=false, 1000); 
                        } else if(landmarks[8].x > 0.8) {
                            idx=(idx-1+photos.length)%photos.length; mainImg.src=photos[idx]; 
                            cooldown=true; setTimeout(()=>cooldown=false, 1000);
                        }
                    }
                }
            } else {
                debugInfo.innerText = "æœªåµæ¸¬åˆ°æ‰‹éƒ¨";
            }
            canvasCtx.restore();
        });

        const cam = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        cam.start();

        function render() {
            requestAnimationFrame(render);
            treeGroup.rotation.y += rotVel;
            renderer.render(scene, camera);
        }
        render();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
