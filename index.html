<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Romantic Xmas - Starry Night</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* æµªæ¼«æ¨™é¡Œ */
        .ui-overlay {
            position: absolute; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;
            display: flex; flex-direction: column; justify-content: space-between; padding: 50px 0;
            text-align: center; color: white;
        }
        .main-title { 
            font-size: 2.5rem; letter-spacing: 15px; font-weight: 100;
            background: linear-gradient(to bottom, #fff, #ffd700);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255,215,0,0.5);
        }

        /* ç›¸ç°¿æ¨¡å¼ */
        #gallery-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.9); z-index: 20;
            opacity: 0; pointer-events: none; transition: 0.8s;
        }
        #gallery-photo { max-width: 80%; max-height: 80%; border-radius: 15px; box-shadow: 0 0 50px #fff3; }

        /* ç…§ç‰‡ç®¡ç† */
        #lib-toggle { position: absolute; top: 20px; left: 20px; z-index: 100; background: none; border: 1px solid #444; color: #888; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; }
        #library { position: absolute; top: 0; left: -320px; width: 300px; height: 100%; background: rgba(10,10,10,0.95); z-index: 99; transition: 0.4s; padding: 20px; color: #ccc; overflow-y: auto; }
        #library.open { left: 0; }
        .slot input { width: 90%; background: #222; border: 1px solid #333; color: #fff; padding: 5px; margin-bottom: 10px; }
        
        #video { position: absolute; bottom: 10px; right: 10px; width: 100px; opacity: 0.2; transform: scaleX(-1); border-radius: 5px; }
        body.gallery-active #canvas-container { filter: blur(20px) brightness(0.5); }
        body.gallery-active #gallery-container { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>
    <button id="lib-toggle">âš™ï¸</button>
    <div id="library">
        <h3>æ˜Ÿå…‰ç›¸ç°¿ç®¡ç†</h3>
        <div id="inputs"></div>
        <button style="width:100%; padding:10px; background:#ffd700; border:none; border-radius:5px;" onclick="saveLib()">å„²å­˜æ›´æ–°</button>
    </div>

    <video id="video" autoplay playsinline muted></video>
    <div id="canvas-container"></div>
    <div id="gallery-container"><img id="gallery-photo" src=""></div>

    <div class="ui-overlay">
        <div class="main-title">STARRY XMAS</div>
        <div id="hint-text" style="color:#ffd700; font-size:14px; opacity:0.7;">âœ¨ æ­£åœ¨è¼‰å…¥æ˜Ÿå…‰ç³»çµ±...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>

    <script type="module">
        import * as THREE from 'three';

        // 1. ç…§ç‰‡è³‡æ–™
        let photos = JSON.parse(localStorage.getItem('xmas_v3')) || ['https://picsum.photos/id/1015/800/1000', 'https://picsum.photos/id/1016/800/1000'];
        const container = document.getElementById('inputs');
        for(let i=0; i<10; i++) container.innerHTML += `<div class="slot"><label>ç…§ç‰‡ ${i+1}</label><input type="text" id="p-${i}" value="${photos[i]||''}"></div>`;
        window.saveLib = () => {
            const nl = []; for(let i=0; i<10; i++) { let v = document.getElementById(`p-${i}`).value; if(v) nl.push(v); }
            localStorage.setItem('xmas_v3', JSON.stringify(nl)); location.reload();
        };
        document.getElementById('lib-toggle').onclick = () => document.getElementById('library').classList.toggle('open');

        // 2. Three.js æ˜Ÿå…‰å ´æ™¯
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 50;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // èƒŒæ™¯æ˜Ÿç©º
        const starGeo = new THREE.BufferGeometry();
        const starPos = [];
        for(let i=0; i<2000; i++) starPos.push((Math.random()-0.5)*200, (Math.random()-0.5)*200, (Math.random()-0.5)*200);
        starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
        const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.15, transparent: true }));
        scene.add(stars);

        // è–èª•æ¨¹
        const treeGroup = new THREE.Group();
        function addP(n, s, c, r, h) {
            const g = new THREE.BufferGeometry(); const p = [];
            for(let i=0; i<n; i++) {
                const t = i/n; const angle = t * Math.PI * 40; const currR = (1-t)*r;
                p.push(Math.cos(angle)*currR+(Math.random()-0.5), t*h-20, Math.sin(angle)*currR+(Math.random()-0.5));
            }
            g.setAttribute('position', new THREE.Float32BufferAttribute(p, 3));
            return new THREE.Points(g, new THREE.PointsMaterial({ size:s, color:c, blending: THREE.AdditiveBlending, transparent:true, opacity:0.7 }));
        }
        treeGroup.add(addP(10000, 0.12, 0x1a4d1a, 18, 45)); // æ¨¹èº«
        treeGroup.add(addP(800, 0.3, 0xffd700, 18.5, 45));  // é‡‘å…‰
        scene.add(treeGroup);

        // 3. æ‰‹å‹¢è¾¨è­˜
        let mode = 'tree', idx = 0, rotVel = 0.005, cooldown = false;
        const img = document.getElementById('gallery-photo'); img.src = photos[0];

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.6 });
        hands.onResults((res) => {
            if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                const m = res.multiHandLandmarks[0];
                const d = Math.sqrt(Math.pow(m[4].x-m[8].x,2) + Math.pow(m[4].y-m[8].y,2));
                document.getElementById('hint-text').innerText = mode==='tree' ? "ğŸ‘ å¼µé–‹æ‰‹é€²å…¥ç›¸ç°¿" : "ğŸ‘Œ æåˆè¿”å›æ˜Ÿç©º";
                
                if(mode==='tree') {
                    rotVel = (m[8].x - 0.5) * 0.15;
                    if(d > 0.4) { mode='gallery'; document.body.className='gallery-active'; }
                } else {
                    if(d < 0.1) { mode='tree'; document.body.className=''; }
                    if(!cooldown && m[8].x < 0.2) { idx=(idx+1)%photos.length; img.src=photos[idx]; cooldown=true; setTimeout(()=>cooldown=false, 1000); }
                }
            }
        });

        const cam = new Camera(document.getElementById('video'), {
            onFrame: async () => { await hands.send({image: document.getElementById('video')}); },
            width: 640, height: 480
        });
        cam.start().catch(()=>document.getElementById('hint-text').innerText="è«‹é–‹å•Ÿç›¸æ©Ÿæ¬Šé™");

        // 4. å‹•ç•«
        function render() {
            requestAnimationFrame(render);
            treeGroup.rotation.y += rotVel;
            stars.rotation.y += 0.0005;
            renderer.render(scene, camera);
        }
        render();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
