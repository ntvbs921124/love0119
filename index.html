<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Xmas Magic - Pro Gallery</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; touch-action: none; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #gallery-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.85); z-index: 2;
            opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
        }
        #gallery-photo {
            max-width: 85%; max-height: 75%; border-radius: 20px;
            box-shadow: 0 0 50px rgba(255,255,255,0.2);
            transform: scale(0.8); transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #library-panel {
            position: absolute; top: 0; left: -320px; width: 300px; height: 100%;
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px);
            z-index: 100; transition: left 0.4s ease; padding: 20px; color: white; overflow-y: auto;
        }
        #library-panel.open { left: 0; }
        .photo-slot { margin-bottom: 10px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; }
        .photo-slot input { width: 90%; background: #222; border: 1px solid #444; color: white; padding: 5px; }
        .lib-btn { background: #ffeb3b; color: black; border: none; padding: 10px; border-radius: 20px; width: 100%; font-weight: bold; margin-top: 10px; cursor: pointer;}
        #lib-toggle { position: absolute; top: 20px; left: 20px; z-index: 101; background: rgba(255,255,255,0.1); color: white; border: 1px solid white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
        .overlay { position: absolute; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 40px 0; color: white; text-align: center; }
        .hint-box { background: rgba(0,0,0,0.6); padding: 15px; border-radius: 40px; align-self: center; border: 1px solid rgba(255,255,255,0.1); }
        #status { font-size: 12px; color: #00ffcc; margin-top: 8px; }
        #video { position: absolute; bottom: 10px; right: 10px; width: 100px; border-radius: 10px; opacity: 0.3; transform: scaleX(-1); pointer-events: none; }
        body.gallery-mode #canvas-container { filter: blur(15px) brightness(0.3); }
        body.gallery-mode #gallery-container { opacity: 1; pointer-events: auto; }
        body.gallery-mode #gallery-photo { transform: scale(1); }
    </style>
</head>
<body>
    <button id="lib-toggle">‚öôÔ∏è</button>
    <video id="video" autoplay playsinline muted></video>
    <div id="library-panel">
        <div style="font-size: 20px; margin-bottom: 15px;">üñºÔ∏è ÁÖßÁâáÂ∫´ (ÊúÄÂ§ö10Âºµ)</div>
        <div id="photo-inputs"></div>
        <button class="lib-btn" onclick="saveLibrary()">ÂÑ≤Â≠òÊõ¥Êñ∞</button>
    </div>
    <div id="canvas-container"></div>
    <div id="gallery-container"><img id="gallery-photo" src=""></div>
    <div class="overlay">
        <div style="font-size: 24px; letter-spacing: 10px;">XMAS MAGIC</div>
        <div class="hint-box">
            <div id="main-hint" style="color: #ffeb3b;">Ë´ãÂÖÅË®±Áõ∏Ê©üÊ¨äÈôê‰ª•ÈÄ≤Ë°å‰∫íÂãï</div>
            <div id="status">Á≥ªÁµ±ËºâÂÖ•‰∏≠...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // 1. ÁÖßÁâáÁÆ°ÁêÜ
        let photoList = JSON.parse(localStorage.getItem('xmas_photos')) || ['https://picsum.photos/id/20/800/1000'];
        const inputs = document.getElementById('photo-inputs');
        for(let i=0; i<10; i++){
            inputs.innerHTML += `<div class="photo-slot"><label>Áõ∏Áâá ${i+1}</label><input type="text" id="p-${i}" value="${photoList[i]||''}"></div>`;
        }
        window.saveLibrary = () => {
            const nl = []; for(let i=0; i<10; i++) { const v = document.getElementById(`p-${i}`).value; if(v) nl.push(v); }
            if(nl.length){ photoList = nl; localStorage.setItem('xmas_photos', JSON.stringify(nl)); location.reload(); }
        };
        document.getElementById('lib-toggle').onclick = () => document.getElementById('library-panel').classList.toggle('open');

        // 2. Three.js ËÅñË™ïÊ®π (ÂÖàÂü∑Ë°å)
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 50;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const treeGroup = new THREE.Group();
        function createP(count, size, color, radius) {
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(count * 3);
            for(let i=0; i<count; i++) {
                const t = i/count;
                const r = (1-t) * radius;
                const a = t * Math.PI * 40;
                pos[i*3] = Math.cos(a)*r + (Math.random()-0.5);
                pos[i*3+1] = t*40 - 20;
                pos[i*3+2] = Math.sin(a)*r + (Math.random()-0.5);
            }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            return new THREE.Points(geo, new THREE.PointsMaterial({ size, color, blending: THREE.AdditiveBlending, transparent: true, opacity: 0.6 }));
        }
        treeGroup.add(createP(12000, 0.15, 0x228b22, 18));
        treeGroup.add(createP(500, 0.3, 0xffd700, 18.5));
        scene.add(treeGroup);

        // 3. MediaPipe ÊâãÂã¢ (ÂæåÂïüÂãï)
        let currentMode = 'tree', currentPhotoIndex = 0, targetRot = 0.005;
        const galleryPhoto = document.getElementById('gallery-photo');
        galleryPhoto.src = photoList[0];

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
        hands.onResults((res) => {
            if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                const marks = res.multiHandLandmarks[0];
                const dist = Math.sqrt(Math.pow(marks[4].x-marks[8].x,2) + Math.pow(marks[4].y-marks[8].y,2));
                document.getElementById('status').innerText = "‚ú® ÊÑüÊáâ‰∏≠";
                if(currentMode==='tree'){
                    targetRot = (marks[8].x - 0.5) * 0.15;
                    if(dist > 0.4) { currentMode='gallery'; document.body.className='gallery-mode'; }
                } else {
                    if(dist < 0.1) { currentMode='tree'; document.body.className=''; }
                    if(marks[8].x < 0.2) { currentPhotoIndex = (currentPhotoIndex+1)%photoList.length; galleryPhoto.src = photoList[currentPhotoIndex]; }
                }
            }
        });

        const videoElement = document.getElementById('video');
        const cameraStart = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        cameraStart.start().catch(() => document.getElementById('main-hint').innerText = "‚ö†Ô∏è Ë´ãÈªûÊìäÁ∂≤ÂùÄÂàóÊóÅÁöÑÁõ∏Ê©üÂúñÁ§∫ÈñãÂïüÊ¨äÈôê");

        // 4. ÂãïÁï´Ëø¥Âúà (Áç®Á´ãÈÅãË°å)
        function animate() {
            requestAnimationFrame(animate);
            treeGroup.rotation.y += targetRot;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
